<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Map and Geospatial Hub 3D Explorer</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.18/esri/themes/light/main.css" />
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">    
    <!-- Load icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>    
    <script src="https://js.arcgis.com/4.18/"></script>

    <style>
      body, html {
        font-family: 'Montserrat', sans-serif !important;
      }
      #viewDiv {
        position: absolute;
        top: 0;
        bottom: 0;        
        padding: 0;
        margin-top: 56px;        
        width: 100%;
      }   

.navbar {
  height: 56.5px;  
}

.navbar-brand {
  padding: 0 15px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;   
}

.navbar-light .navbar-nav .nav-link {
  color: #d9dde0;
  font-size: 13px;
}

.navbar-light .navbar-nav .nav-link:hover {
  color: white;  
}

#search {
  width: 50%;
  border-radius: 5px 0px 0px 5px;
}

#searchtype {  
  z-index: 2;
  width: 15%;
  border-radius: .0rem .0rem .0rem .0rem;
}

#searchtype:focus {
  box-shadow: 0px 0px 0px;
    border-color: #8c1d40;
    outline: 0px
}

.navbar-light .navbar-brand {
  color: white;
}
.bg-light {
  background: #292929 !important;
  border-bottom: solid 2px black;
}        

.container {
    position: absolute;
    width: 60%;
    top: 71px;
    left: 45px;
}

.btn:hover {
    color: #fff
}

.input-text:focus {
    box-shadow: 0px 0px 0px;
    border-color: #8c1d40;
    outline: 0px
}

.form-control {
    border: 1px solid  #8c1d40
    z-index: 999999999;
}

.btn-outline-warning {
  color: #fff;
  border-color: #8c1d40;
  background-color: #8c1d40;
}

.btn-outline-warning:hover {
  color: #fff;
  border-color: #D23153;
  background-color: #D23153;
}

#close {
  background-color: #8c1d40;
  border-color: #8c1d40;
}

.navbar-brand {
  position: absolute;       
  left: 0;        
}

.navbar-light .navbar-brand:hover {
  color: white;      
}

#advancedBtn {
  background-color: #8c1d40;
  border-color: #8c1d40;
}
 
.btn-outline-success {
  display: inline-block;
  margin-left: 15px;
  color: #8c1d40;
  border-color: #8c1d40;
}

.btn-outline-success:hover {  
  background-color: #8c1d40;
  border-color: #8c1d40;  
}

#tablebtn {
  width: 50%;
  font-size: 10px;
  color: white;  
  border-radius: 0px;
  padding: 12px;
  background-color: #8c1d40;
  border-color:#8c1d40;  
}

#tablebtn:hover {
  border-color: #D23153;
  background-color: #D23153
}

.esri-widget {
  font-family: 'Montserrat', sans-serif;
}

/*.modal {
    pointer-events: none;
}
.modal-backdrop {
    display: none;
}*/
body:not(.esriIsPhoneSize) #viewDiv .esri-popup.esri-popup--is-docked .esri-popup__main-container {
    width: 296px;
    box-shadow: 0px 0px 3px rgba(0, 0, 0, 0.4);
    padding-bottom: 55px;
}

body:not(.esriIsPhoneSize) #viewDiv .esri-popup.esri-popup--is-docked .esri-popup__main-container .esri-popup__footer.esri-popup__footer--has-actions .esri-popup__inline-actions-container {
    margin: 15px;
    margin-top: 0;
    width: 100%;
    margin-bottom: 8px;
}

body:not(.esriIsPhoneSize) #viewDiv .esri-popup.esri-popup--is-docked .esri-popup__main-container .esri-popup__footer.esri-popup__footer--has-actions .esri-popup__button.esri-popup__action {
    height: 35px;
    font-size: 12px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    -moz-user-select: none;
    box-sizing: border-box;
    cursor: pointer;
    display: inline-block;
    letter-spacing: 1px;
    line-height: 1.71429em;
    text-transform: uppercase;
    color: #6aa23f;
    background: none;
    border: solid 1px #6aa23f;
    width: 100%;
    margin: 0;
    text-align: center;
    padding: 0;
    line-height: 35px;
    margin-top: 10px;
}

#viewDiv .esri-popup__inline-actions-container:only-child > .esri-popup__action {
  max-width: none;
}

.esri-popup__inline-actions-container>.esri-popup__action, .esri-popup__inline-actions-container>.esri-popup__action-toggle {
  flex: 0 1 auto;
}

.esri-popup__footer .esri-popup__button {
    font-weight: 500;
    font-size: 12px;
    position: relative;
    display: flex;
    justify-content: flex-start;
    flex: 0 0 auto;
}

body:not(.esriIsPhoneSize) #viewDiv .esri-popup.esri-popup--is-docked .esri-popup__main-container .esri-popup__footer.esri-popup__footer--has-actions {
    bottom: 0;
    top: auto;
    position: absolute;
    width: 100%;
    margin-top: 0;
    padding-top: 0;
}


    </style>

    <script>    

      
      // JS for the map
      require(["esri/Map", "esri/views/SceneView", "esri/WebScene", "esri/layers/SceneLayer", "esri/tasks/support/Query",
        "esri/widgets/Home", "esri/geometry/Extent"], function(
        Map,
        SceneView,
        WebScene,
        SceneLayer,
        Query,
        Home,
        Extent      
      ) { 
        // Important variables for connecting the sceneview to the AGOL API  
        // Service URL for the maps_master table on AGOL    
        var tableURL = "https://services3.arcgis.com/0OPQIK59PJJqLK0A/ArcGIS/rest/services/maps_master/FeatureServer/0/";
        // Title for the Cabinets Layer
        var cabTitle = "Map Cabinets Update - Map Cabinets";
        // Title for the Bookshelves layer
        var shelfTitle = "Bookshelves Update - Bookshelves";       
       
        // setup the variable for highlight with no value  
        var highlight = null;  

        // Load webscene from portal item
        var webscene = new WebScene({
          portalItem: {
            // autocasts as new PortalItem()
            id: "78d7af4d3b524ddda205fe1c542c52ac"
          }
        });   

        var view = new SceneView({
          container: "viewDiv",
          highlightOptions: {
            color: [210, 49, 83] // color of the highlight when a feature is selected
          }, 
          map: webscene,          
          //zoom: 21,
          /*camera: {
            position: {
              latitude: 33.41905660,
              longitude: -111.93427050,
              z: 26.78385
            },
            tilt: 67.13,
            heading: 338.63
          }*/
        });    

       /* view.constraints = {
          geometry: {            // Constrain lateral movement to Lower Manhattan
            type: "extent",
            xmin: -111.9345778519999,
            ymin:  33.41921250900003,
            xmax: -111.93427068599996,
            ymax:  33.419464501000036,
            zmin: 8.055864,
            zmax: 10.646664
          },
          minScale: 500000,      // User cannot zoom out beyond a scale of 1:500,000
          maxScale: 0,           // User can overzoom tiles
          rotationEnabled: true // Disables map rotation
        };    */
        
        // Dock the popup to a fixed position
        view.popup.dockOptions = {
          // Disable the dock button so users cannot undock the popup
          buttonEnabled: false,
          // Dock the popup when the size of the view is less than or equal to 600x1000 pixels
          breakpoint: {
            width: 10000,
            height: 10000
          }
        };
        
        // Creates a  new table to hold our map attributes  
        var table = new Tabulator("#drawers-table", {             
            height: 350,            
            selectable: 1,
            clipboard:true, //enable clipboard functionality
            //autoResize:false,  
            columns:[
                {title:"Title", field:"attributes.TITLE", width: 500},
                {title:"Author", field:"attributes.AUTHOR", width: 300},
                {title:"Publisher", field:"attributes.PUBLISHER", width: 300},
                {title:"Publication Date", field:"attributes.DATE", width: 150},
                {title:"Scale", field:"attributes.SCALE", width: 120},
                {title:"Catalog Item", field:"attributes.CATALOG_LINK", width: 400, formatter:"link", formatterParams:{                   
                   target:"_blank",
                }},
                {title:"Call Number", field:"attributes.CALL_NUM", width: 250},                                
                {title:"Language", field:"attributes.LANG", width: 150},
                {title:"Theme", field:"attributes.THEME", width: 150},
                {title:"Region / Geography", field:"attributes.GEO", width: 200},                
                {title:"Drawer ID", field:"attributes.LOC_ID", width: 100},                
            ],            
            // Detect when someone clicks on a row in the table
            rowClick:function(e, row){ 
              view.popup.close();   
              // When the table row is clicked hide the table 
              $('#drawerModal').modal('hide');        
              //e - the click event object
              //row - row component
              // Get the LOC_ID from the selected row in the table            
              var drawerId = row._row.data.attributes.LOC_ID;               
              console.log('you clicked a row'); 
              if (drawerId < 241) {
                // Get the cabinets layer from webScene
                var cabLayer = webscene.allLayers.filter(function(elem) {
                  return elem.title === cabTitle;
                }).items[0];        
                var query = cabLayer.createQuery();
                // Query the cabinets layer for the LOC_ID
                query.where = "LOC_ID =" + "'" + drawerId + "'";
                query.returnGeometry = true;               
                query.returnZ = true;
                query.outFields = ["OBJECTID", "LOC_ID", "Z_Min", "Z_Max"];
                cabLayer.queryFeatures(query)
                  .then(function(response){
                     // returns a feature set with features containing an OBJECTID
                     var objectID = response.features[0].attributes.OBJECTID;
                     //var cabId = response.features[0].attributes.CAB_ID;
                     var zmin = (response.features[0].attributes.Z_Min / 3.28);
                     var zmax = (response.features[0].attributes.Z_Max / 3.28);
                    
                     view.whenLayerView(cabLayer).then(function(layerView) {
                        var queryExtent = new Query({
                          objectIds: [objectID]
                        });
                        // zoom to the extent of drawer that is clicked on the table  
                        var new_ext = new Extent({
                          xmin: response.features[0].geometry.extent.xmin, 
                          ymin: response.features[0].geometry.extent.ymin, 
                          zmin: zmin,
                          xmax: response.features[0].geometry.extent.xmax, 
                          ymax: response.features[0].geometry.extent.ymax,
                          zmax: zmax,                        
                          spatialReference: { wkid: 4326 }
                        });

                        cabLayer.queryExtent(queryExtent).then(function(result) {
                          view.goTo(new_ext.expand(3), { speedFactor: 0.5 });                        
                        });
                        
                        // if any, remove the previous highlights
                        if (highlight) {
                          highlight.remove();
                        }
                        // highlight the feature with the returned objectId
                        highlight = layerView.highlight([objectID]);
                        })
                        // open a popup at the drawer location of the selected map
                        view.popup.open({
                          // Set the popup's title to the coordinates of the clicked location
                          title: "<h6><b>Drawer ID: "  + drawerId + "</b>",  
                          content: "The item " + '<b>"' + row._row.data.attributes.TITLE + '"</b> ' + "is located in Drawer " + drawerId + ".",
                          location: response.features[0].geometry.centroid, // Set the location of the popup to the clicked location 
                          actions: [returnToAction]      
                        });
                   });           
            } else if (drawerId >= 241) {
              // Get the cabinets layer from webScene
                var shelfLayer = webscene.allLayers.filter(function(elem) {
                  return elem.title === shelfTitle;
                }).items[0];        
                var query = shelfLayer.createQuery();
                // Query the cabinets layer for the LOC_ID
                query.where = "LOC_ID =" + "'" + drawerId + "'";
                query.returnGeometry = true;               
                query.returnZ = true;
                query.outFields = ["OBJECTID", "LOC_ID", "Z_Min", "Z_Max"];
                shelfLayer.queryFeatures(query)
                  .then(function(response){
                     // returns a feature set with features containing an OBJECTID
                     var objectID = response.features[0].attributes.OBJECTID;
                     //var cabId = response.features[0].attributes.CAB_ID;
                     var zmin = (response.features[0].attributes.Z_Min / 3.28);
                     var zmax = (response.features[0].attributes.Z_Max / 3.28);
                    
                     view.whenLayerView(shelfLayer).then(function(layerView) {
                        var queryExtent = new Query({
                          objectIds: [objectID]
                        });
                        // zoom to the extent of drawer that is clicked on the table  
                        var new_ext = new Extent({
                          xmin: response.features[0].geometry.extent.xmin, 
                          ymin: response.features[0].geometry.extent.ymin, 
                          zmin: zmin,
                          xmax: response.features[0].geometry.extent.xmax, 
                          ymax: response.features[0].geometry.extent.ymax,
                          zmax: zmax,                        
                          spatialReference: { wkid: 4326 }
                        });

                        shelfLayer.queryExtent(queryExtent).then(function(result) {
                          view.goTo(new_ext.expand(3), { speedFactor: 0.5 });                        
                        });
                        
                        // if any, remove the previous highlights
                        if (highlight) {
                          highlight.remove();
                        }
                        // highlight the feature with the returned objectId
                        highlight = layerView.highlight([objectID]);
                        })
                        // open a popup at the drawer location of the selected map
                        view.popup.open({
                          // Set the popup's title to the coordinates of the clicked location
                          title: "The item " + '"' + row._row.data.attributes.TITLE + '" ' + "is located in Shelf " + drawerId + ".", 
                          location: response.features[0].geometry.centroid,// Set the location of the popup to the clicked location  
                          actions: [returnToAction]      
                        });
                   });
            }   
          }
        });        
        
        //trigger download of mapdata.csv file
        $("#download").click(function(){
            table.download("csv", "mapdata.csv", {sheetName:"Map Data"});
        });        

        view.when(function() {
          // Get the cabinets layer from webScene
          var cabLayer = webscene.allLayers.filter(function(elem) {
            return elem.title === cabTitle;
          }).items[0];
          // get the LOC_ID and DRAWER_TITLE  
          cabLayer.outFields = ['LOC_ID', 'DRAWER_TITLE'];

          // Get the bookshelves layer from webScene
          var shelfLayer = webscene.allLayers.filter(function(elem) {
            return elem.title === shelfTitle;
          }).items[0];
          // get the LOC_ID and DRAWER_TITLE  
          shelfLayer.outFields = ['LOC_ID'];
  
          // retrieve the layer view of the scene layer
          view.whenLayerView(cabLayer, shelfLayer)
            .then(function(cabLayerView, shelfLayerView) {
              view.on("click", function(event) { 
                // if any, remove the previous popup actions
                view.popup.actions = [];
                // if any, remove the previous highlights
                if (highlight) {
                  highlight.remove();
                }

                view.hitTest(event, { include: [cabLayer, shelfLayer] }).then(function(response) {            
                  // check if a feature is returned from the cabLayer
                  if (response.results.length) {                                 
                    $(".esri-icon-table").hide();
                    const graphic = response.results[0].graphic;
                    console.log(graphic.attributes);
                    // Get the LOC_ID of the clicked drawer
                    var drawerId = graphic.attributes.LOC_ID;
                    var drawerTitle = graphic.attributes.DRAWER_TITLE;
                    var shelfTitle = graphic.attributes.Feature; 
                    //var cabId = graphic.attributes.CAB_ID;
                    $('#drawerTitle').html("Drawer " + drawerId + ": " + drawerTitle);
                    console.log(drawerId);
                    // Call to the ArcGIS REST API to retreive the maps in each drawer
                    $.ajax({
                            dataType: 'json',
                            url: tableURL + 'query?where=LOC_ID+%3D+' + drawerId + '&objectIds=&time=&resultType=none&outFields=*&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                            type: "GET",    
                            success: function(data) {
                             if (data.features.length <= 0) {
                              cabLayer.popupTemplate = {
                                  title: "<h6>Drawer ID: " + drawerId,
                                  content: "Description: " + drawerTitle + "<br><br>Inventory coming soon!"                         
                               };
                               shelfLayer.popupTemplate = {
                                  title: "<h6>Shelf ID: " + drawerId,
                                  //content: "Drawer Title: " + drawerTitle + "<br><br>Inventory coming soon!"                         
                               };
                               //$('#noDataModal').modal('show');
                               //view.popup.close();
                             } else {
                               // show the cabinet info div
                               $("#drawerTitle").show(); 
                               console.log(data.features);
                               // Get the features from the REST API 
                               var features = data.features;     
                               //$('#drawerModal').modal('show');                            
                               var numResults = data.features.length;
                               var startCallNo = data.features[0].attributes.CALL_NUM;
                               var endCallNo = data.features[numResults - 1].attributes.CALL_NUM;                               
                               cabLayer.popupTemplate = {
                                  title: "<b><h6>Drawer ID: " + drawerId + "</b>" ,
                                  content: "<h6>Description: "  + drawerTitle + "<br><br> Item Count: " + numResults +
                                  "<br><br>Range: " + startCallNo + " - " + endCallNo,           
                                  actions: [tableViewerAction] // adds the custom popup action
                               };

                               shelfLayer.popupTemplate = {
                                  title: "<b><h6>Shelf ID: " + drawerId + "</b>" ,
                                  content: "<h6>Description: "  + shelfTitle + "<br><br> Item Count: " + numResults +
                                  "<br><br>Range: " + startCallNo + " - " + endCallNo,           
                                  actions: [tableViewerAction] // adds the custom popup action
                               };

                               $('#results').html(" | Item count: " + numResults + " items");  
                               // Create a new table with the array of features 
                               table.setData(features);                                 
                             }
                            }
                    });   
                  }
                });
            }); //end map click
          });
        }); // end of view   

        // Change the appearance of the popup based on which layer is selected
        view.when(function () {
          // Watch for when features are selected
          view.popup.watch("selectedFeature", function (graphic) {
            if (graphic) {
              if (graphic.layer.title == cabTitle || graphic.layer.title == shelfTitle) {
                $(function() {            
                $("body:not(.esriIsPhoneSize) #viewDiv .esri-popup.esri-popup--is-docked .esri-popup__main-container").css('padding-bottom', '55px');                 
              });
              } else  if (graphic.layer.title != cabTitle || graphic.layer.title != shelfTitle) {
                $(function() {            
                $("body:not(.esriIsPhoneSize) #viewDiv .esri-popup.esri-popup--is-docked .esri-popup__main-container").css('padding-bottom', '0px');                
              });
              }              
            }
          })
        });

        // Code for the search bar functions
        $( "#submit" ).click(function() {
          view.popup.close();
         // $(".esri-icon-table").show();
          // get the value of the search box
          var searchVal = $( "#search" ).val();
          // get the value of the search type dropdwn
          var typeVal = $( "#searchtype" ).val();
          if (typeVal == 'Keyword') {
            // call to query the REST API using the value of the search
            $.ajax({
                    dataType: 'json',
                    url: tableURL + 'query?where=TITLE+LIKE+%27%25' + searchVal + '%25%27+OR+THEME+LIKE+%27%25' + searchVal + '%25%27+OR+Geo+LIKE+%27%25' + searchVal +'%25%27+OR+DATE+LIKE+%27%25' + searchVal + '%25%27+OR+PUBLISHER+LIKE+%27%25' + searchVal + '%25%27+OR+AUTHOR+LIKE+%27%25' + searchVal + '%25%27+OR+SCALE+LIKE+%27%25' + searchVal + '%25%27+OR+LANG+LIKE+%27%25' + searchVal + '%25%27&objectIds=&time=&resultType=none&outFields=*&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                    type: "GET",    
                    success: function(data) {
                     if (data.features.length == 0) {
                      alert('The search returned no results. Please try different terms.');
                     } else {                     
                       // hide the cabinet info div
                       $("#drawerTitle").hide(); 
                       console.log(data.features);
                       // Get the features from the REST API 
                       var searchRes = data.features;  
                       $('#drawerModal').modal('show'); 
                       // Get the number of results of the search
                       var numResults = data.features.length;    
                       $('#results').html(numResults + " items found for " + '"' + searchVal + '"');                  
                       // Create a new table with the array of features 
                       table.setData(searchRes);
                      }
                    }
            });  
          } else if (typeVal == 'Call Number') {            
            // call to query the REST API using the value of the search
            $.ajax({
                    dataType: 'json',
                    url: tableURL + 'query?where=CALL_NUM+LIKE+%27%25' + searchVal + '%25%27&objectIds=&time=&resultType=none&outFields=*&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                    type: "GET",    
                    success: function(data) {
                      if (data.features.length == 0) {
                        alert('The search returned no results. Please try different terms.');
                      } else {
                       // hide the cabinet info div
                       $("#drawerTitle").hide();  
                       console.log(data.features);
                       // Get the features from the REST API 
                       var searchRes = data.features;  
                       $('#drawerModal').modal('show');  
                       var numResults = data.features.length;    
                       $('#results').html(numResults + " items found for " + '"' + searchVal + '"');
                       // Create a new table with the array of features 
                       table.setData(searchRes);
                      }
                    }
            });  
          }   
        });

       // if users hits enter perform the search   
       $( "#search" ).keyup(function(event) {
          // Number 13 is the "Enter" key on the keyboard
          if (event.keyCode === 13) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger the button element with a click
            document.getElementById("submit").click();
          }        
       }); 

        // Code for the search dropdown menu
        $("#searchtype").change(function () {
          // Get the value of the selected item
          var value = this.value;
          if (value == 'Keyword') {
            $('#search').attr("placeholder", "Search items...");
          } else if (value == 'Call Number') {
             $('#search').attr("placeholder", "Enter Call # (ie: G3300 1818 .H4 REF)");            
          } else if (value == 'Date') {
            //$('#yearModal').modal('show');
            $('#search').attr("placeholder", "Enter Year Range (Format: YYYY-YYYY)"); 
          } else if (value == 'Location') {            
            $('#search').attr("placeholder", "Search location (ie: Arizona)"); 
          } else if (value == 'Theme') {            
            $('#search').attr("placeholder", "Search by theme (ie: Land use)"); 
          } else if (value == 'Advanced') {
             
            $('#advancedModal').modal('show');
          }
        });

         // Code to populate the Advanced Search Dropdown Menus
         // Populate the Theme dropdown item
         $.ajax({
                  dataType: 'json',
                  url: tableURL + 'query?where=1%3D1&objectIds=&time=&resultType=none&outFields=THEME&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=true&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                  type: "GET",    
                  success: function(data) {
                    var themeSelect = document.getElementById('theme');
                    var features = data.features;    
                    Object.values(features).forEach(function(value) {                                         
                      var themeVal = value.attributes.THEME;
                      var themeOpt = document.createElement("option");
                      themeOpt.textContent = themeVal;
                      themeOpt.value = themeVal;
                      themeSelect.appendChild(themeOpt);                                         
                    });                     
                  }
          }); 

          // Populate the Location dropdown item
         $.ajax({
                  dataType: 'json',
                  url: tableURL + 'query?where=1%3D1&objectIds=&time=&resultType=none&outFields=GEO&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=true&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                  type: "GET",    
                  success: function(data) {
                    var geoSelect = document.getElementById('location');
                    var features = data.features;    
                    Object.values(features).forEach(function(value) {                                          
                      var geoVal = value.attributes.GEO;
                      var geoOpt = document.createElement("option");
                      geoOpt.textContent = geoVal;
                      geoOpt.value = geoVal;
                      geoSelect.appendChild(geoOpt);                                         
                    });                     
                  }
          });   
         // Populate the Language dropdown item
         $.ajax({
                  dataType: 'json',
                  url: tableURL + 'query?where=1%3D1&objectIds=&time=&resultType=none&outFields=LANG&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=true&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                  type: "GET",    
                  success: function(data) {
                    var langSelect = document.getElementById('language');
                    var features = data.features;    
                    Object.values(features).forEach(function(value) {                                          
                      var langVal = value.attributes.LANG;
                      var langOpt = document.createElement("option");
                      langOpt.textContent = langVal;
                      langOpt.value = langVal;
                      langSelect.appendChild(langOpt);                                         
                    });                     
                  }
          });  

        // Function to rotate the map
        function rotate() {         
          view.goTo({
              heading: view.camera.heading + 0.2,
              center: view.center
          }, {animate: false});
          // begin the rotation
          var req = requestAnimationFrame(rotate);            
          // when the user clicks on the pause button
          pauseBtn.addEventListener('click', function(event){  
            // cancel the rotation
            cancelAnimationFrame(req);
            $(".esri-icon-play").show(); 
            $(".esri-icon-pause").hide();     
          })
        };    

        // Custom Buttons
         var homeBtn = new Home({
          view: view
        });

        // Add the home button to the top left corner of the view
        view.ui.add(homeBtn, "top-left");        
        
        // If the advanced search is closed, change the search value back to Keyword
        $('#advancedModal').on('hidden.bs.modal', function (e) {
          $('#searchtype')
            .val('Keyword')
            .trigger('change');
        })

        // Rotate play button
        var rotateBtn = document.createElement('div');        
        rotateBtn.className = "esri-icon-play esri-widget--button esri-widget esri-interactive";
        rotateBtn.title = "Auto-rotate map";
        rotateBtn.addEventListener('click', function(event){
          rotate();
          $(".esri-icon-play").hide();
          $(".esri-icon-pause").show();         
        })

        // Add the button to the UI
        view.ui.add(rotateBtn, "top-left");

        // Pause button
        var pauseBtn = document.createElement('div');
        pauseBtn.className = "esri-icon-pause esri-widget--button esri-widget esri-interactive";
        pauseBtn.title = "Pause rotation";

        // Add the button to the UI
        view.ui.add(pauseBtn, "top-left"); 

        $(".esri-icon-pause").hide();

        // Add element for the 360 photo viewer button using Esri widgets
        var viewerBtn = document.createElement('div');
        viewerBtn.className = "esri-icon-media esri-widget--button esri-widget esri-interactive";
        viewerBtn.title = "view 360 hub image";
        viewerBtn.addEventListener('click', function(event){
          // Toggle table
          $('#viewerModal').modal('show');
        })

        // Add the button to the UI
        view.ui.add(viewerBtn, "top-left"); 

        /*// Add element for the table button using Esri widgets
        var tableBtn = document.createElement('div');
        tableBtn.className = "esri-icon-table esri-widget--button esri-widget esri-interactive";
        tableBtn.title = "Open table";
        tableBtn.addEventListener('click', function(event){
          // Toggle table
          $('#drawerModal').modal('show');
        })

        // Add the button to the UI
        view.ui.add(tableBtn, "top-left"); 
        // Hide the button by default  
        $(".esri-icon-table").hide();        */

        // when someone clicks the advanced search submit button        
        $("#advancedBtn").click(function(){
          view.popup.close();
          // create an empty array for search strings
          var searchStrings = [];
          // get the values of the boxes from the advanced search modal
          var themeVal = $("#theme").val();
          var langVal = $('#language').val();
          var geoVal = $("#location").val();
          var authorVal = $('#author').val();
          var pubVal = $('#publisher').val();
          var startYearVal = $("#startYear").val();
          var endYearVal = $("#endYear").val();
          console.log(themeVal, langVal, geoVal, authorVal, pubVal, startYearVal, endYearVal);
          // if the search boxes are blank print error message
          if (themeVal == 'Select Theme' && langVal == 'Select Language' && geoVal == 'Select Region / Geography' && authorVal == "" 
            && pubVal == "" && startYearVal == "" && endYearVal == "") {
            alert('Please select or enter a value for at least one search field.')
          } else if (startYearVal != "" && endYearVal == "" || startYearVal == "" && endYearVal != "") {
            alert('Please enter a value for both Start Year and End Year');
          } else {
            if (themeVal != 'Select Theme') {              
              var themeString = "THEME = " + "'" + themeVal + "'"; 
              searchStrings.push(themeString);                      
            }
            if (langVal != 'Select Language') {              
              var langString = "LANG = " + "'" + langVal + "'"; 
              searchStrings.push(langString);                         
            }
            if (geoVal != 'Select Region / Geography') {              
              var geoString = "GEO = " + "'" + geoVal + "'";
              searchStrings.push(geoString);                   
            }
            if (authorVal != "") {              
              var authorString = "AUTHOR LIKE " + "'%" + authorVal + "%'"; 
              searchStrings.push(authorString);                    
            }
            if (pubVal != "") {              
              var pubString = "PUBLISHER LIKE " + "'%" + pubVal + "%'"; 
              searchStrings.push(pubString);                      
            }
            if (startYearVal != "" && endYearVal != "" ) {              
              var dateString = "DATE BETWEEN " + "'" + startYearVal + "' AND " + "'" + endYearVal + "'";
              searchStrings.push(dateString);                    
            }
            // join the search strings from the array
            var queryString = searchStrings.join(" AND ");
            console.log(queryString);

            // call to the rest api with the search string
            $.ajax({
                    dataType: 'json',
                    url: tableURL + 'query?where=' + queryString + '&objectIds=&time=&resultType=none&outFields=*&returnHiddenFields=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson',
                    type: "GET",    
                    success: function(data) {
                      console.log(data);
                      var advancedRes = data.features;
                      table.setData(advancedRes);  
                      var numResults = advancedRes.length;    
                      $('#results').html(numResults + " items found for advanced search");   
                      $("#drawerTitle").hide();                                                    
                      }                     
                });   
            $('#drawerModal').modal('show');
            $('#advancedModal').modal('hide');    
          }      
        });

        // check if the years are valid numbers
        $('#startYear').change(function() {
          $(this).val($(this).val().match(/\d*\.?\d+/));
        });

        $('#endYear').change(function() {
          $(this).val($(this).val().match(/\d*\.?\d+/));
        });

        // Popup Actions        
        // remove the zoom-to popup action  
        view.popup.actions = [];
        // popup action for maps
        var tableViewerAction = {
          // This text is displayed as a tooltip
          title: "View item list",
          // The ID by which to reference the action in the event handler
          id: "view-table",
          // Sets the icon font used to style the action button
          className: "esri-icon-collection"
        };  

        var returnToAction = {
          // This text is displayed as a tooltip
          title: "Return to results",
          // The ID by which to reference the action in the event handler
          id: "return-to",
          // Sets the icon font used to style the action button
          className: "esri-icon-table"
        };               

        // This event fires for each click on any action
        view.popup.on("trigger-action", function(event){
          // If the view image action is clicked, open the table modal
          if(event.action.id === "view-table"){
            $('#drawerModal').modal('show');
            table.redraw(true);
          }
          if(event.action.id === "return-to"){
            $('#drawerModal').modal('show');            
          }
        });        
      }); // end of map JS
    </script>
  </head>

  <body>
    <nav class="navbar navbar-expand-md navbar-light bg-light">
  <a class="navbar-brand">
    <img src="asulogo.png" width="50" height="50" class="d-inline-block align-top" alt="">
      &nbsp;Map and Geospatial Hub 3D Explorer
  </a>
  <div class="collapse navbar-collapse" id="navbarNav" style="">
        <ul class="navbar-nav mr-auto">           
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href=" https://geospatial.asu.edu" target="_blank" rel="noopener">Map and Geospatial Hub</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://lib.asu.edu/geo/services" target="_blank" rel="noopener">Submit a Service Request</a>
            </li>
        </ul>
    </div>
</nav>
    <div id="viewDiv"></div>
    <!-- Image and text -->

    <div class="modal" id="drawerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document" style="position:absolute;bottom:0;margin:0;width:100%; max-width: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><div id="drawerTitle" style="display: inline-block;"></div>&nbsp;<div id="results" style="display: inline-block;"></div></h5>
          <button type="button" class="btn btn-outline-success" id="download"><i class="fa fa-download" aria-hidden="true" title="Download table"></i> </button>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="drawers-table"></div>
        </div>        
      </div>
    </div>
</div>

<div class="modal" id="viewerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Hub 360 Photo Viewer</h5> 
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>         
        </div>
        <div class="modal-body">
          <iframe width="760" height="400" allowfullscreen style="border-style:none;" src="https://cdn.pannellum.org/2.5/pannellum.htm#panorama=https%3A//rcowling.github.io/3dhub/viewerimage.jpg&autoLoad=true"></iframe>
        </div>        
      </div>
    </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="advancedModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Advanced Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Complete fields for at least one criteria. Fields can be left blank.</p>
        <form>
   <div class="form-row">    
    <div class="form-group col-md-6">
      <label for="theme">Theme</label>
      <select id="theme" class="form-control">
        <option selected>Select Theme</option>        
      </select>
    </div> 
    <div class="form-group col-md-6">
      <label for="language">Language</label>
      <select id="language" class="form-control">
        <option selected>Select Language</option>        
      </select>
    </div>
   </div>
  <div class="form-row">  
    <div class="form-group col-md-12">  
     <label for="location">Region / Geography</label>
      <select id="location" class="form-control">
        <option selected>Select Region / Geography</option>        
      </select>
    </div>  
  </div>          
  <div class="form-row">  
    <div class="form-group col-md-6">  
      <label for="author">Author</label>
      <input type="text" class="form-control" id="author" placeholder="Author">
    </div>      
    <div class="form-group col-md-6">
      <label for="publisher">Publisher</label>
      <input type="text" class="form-control" id="publisher" placeholder="Publisher">
    </div>      
  </div>                
  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="startYear">Start Year</label>
      <input type="text" class="form-control" id="startYear" placeholder="Start Year">
    </div>
    <div class="form-group col-md-6">
      <label for="endYear">End Year</label>
      <input type="text" class="form-control" id="endYear" placeholder="End Year">
    </div>
    <p>*year format should be YYYY (ie: 1850)</p>
  </div>  
</form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="advancedBtn">Search</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="noDataModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Drawer Missing Data</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Oops. It looks like we don't have any data available at the moment for this drawer. We are working hard to inventory our maps.
        Please check back soon or visit the Map and Geospatial Hub to view our map collections.</p>        
      </div>
      <div class="modal-footer">        
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="close">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="container justify-content-center">
    <div class="row">
        <div class="col-md-8">
            <div class="input-group mb-3"> <input type="text" class="form-control input-text" placeholder="Search items..." aria-label="Title Search" id="search" aria-describedby="basic-addon2">
                <select class="form-control" id="searchtype">
                  <option>Keyword</option>
                  <option>Call Number</option>  
                  <option>Advanced</option>
                </select>
                <div class="input-group-append"> <button class="btn btn-outline-warning btn-lg" type="button" id="submit" title="Search"><i class="fa fa-search"></i></button> </div>
            </div>
        </div>
    </div>
</div>

  </body>
</html>
